---
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "metropolis", "metropolis-fonts", "css/custom_design.css"]
    lib_dir: libs
    nature:
      beforeInit: "libs/cols_macro.js"
      highlightStyle: zenburn
      highlightLines: true
      countIncrementalSlides: false

---

```{r setup, include=FALSE}
# libraries --------------------------------------------------------------------
library(anicon)
library(countdown)
library(emo)
library(fontawesome)
library(gapminder)
library(here)
library(tidyverse)
library(knitr)

# options ----------------------------------------------------------------------
options(scipen = 999)
opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE, fig.retina = 3, fig.align = "center")

# functions --------------------------------------------------------------------
# https://bookdown.org/yihui/rmarkdown-cookbook/font-color.html#using-an-r-function-to-write-raw-html-or-latex-code
colorize <- function(x, color) {sprintf("<span style='color: %s;'>%s</span>", color, x)}

# data -------------------------------------------------------------------------
data_full <- gapminder |>
  write_csv(here("data/tutorial/data_full.csv"))

data_left <- gapminder |>
  select(country, year, pop) |>
  write_csv(here("data/tutorial/data_left.csv"))

data_right_1 <- gapminder |>
  select(country, year, lifeExp) |>
  write_csv(here("data/tutorial/data_right_1.csv"))

data_right_2 <- gapminder |>
  select(location = country, date = year, gdpPercap) |>
  write_csv(here("data/tutorial/data_right_2.csv"))

data_right_3 <- gapminder |>
  select(country, continent) |>
  distinct() |>
  write_csv(here("data/tutorial/data_right_3.csv"))
```

class: title-slide, middle

# Quarto Tutorial

## Visualisation and Report Design

### Damien Dupré - Dublin City University

---

# "Gapminder" Dataset

In February 2006, a Swedish physician and data advocate named Hans Rosling gave a TED talk titled **“The best stats you’ve ever seen”** where he presented global economic, health, and development data from the website www.gapminder.org. For this tutorial, are going to use a dataset from this website.

For each row, we have 6 columns:
- **country**: Name of country.
- **year**: Year of the observation (between 1952 and 2007).
- **pop**: Number of people living in the country.
- **continent**: Which of the five continents the country is part of. 
- **lifeExp**: Life expectancy in years.
- **gdpPercap**: Gross domestic product (in US dollars).

```{r}
kable(head(gapminder))
```

---
class: inverse, mline, center, middle

# Visualisation Design

---

# Load libraries

Load the libraries **tidyverse** and **gapminder** with the following code:

```markdown
library(tidyverse)
library(gapminder)
```

If you obtain the following message:

```{r results='asis'}
colorize("Error in library(tidyverse) : there is no package called ‘tidyverse’", "red")
```

or

```{r results='asis'}
colorize("Error in library(gapminder) : there is no package called ‘gapminder’", "red")
```

Then, install these packages.

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

class: title-slide, middle,

## Part 1: Joining Tables

---

# Joining Tables Exercises

## On the module loop page, download the following files and have a look at them:
- ## data_left.csv
- ## data_right_1.csv
- ## data_right_2.csv
- ## data_right_3.csv

---

# Joining Tables Exercises

## Using a **_join()** function (e.g., `left_join()`, `right_join()`, `inner_join()`, or `full_join()`), join data_left.csv with data_right_1.csv

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Joining Tables Exercises

.pull-left[
## data_left.csv
```{r}
head(gapminder) |> 
  select(country, year, pop) |> 
  kable()
```
]

.pull-right[
## data_right_1.csv
```{r}
head(gapminder) |> 
  select(country, year, lifeExp) |> 
  kable()
```
]

```r
data_left <- read_csv("data_left.csv")
data_right_1 <- read_csv("data_right_1.csv")

data_join_1 <- full_join(data_left, data_right_1)
# or
data_join_1 <- full_join(data_left, data_right_1, by = join_by(country, year))
```

---

# Joining Tables Exercises

## Using a **_join()** function (e.g., `left_join()`, `right_join()`, `inner_join()`, or `full_join()`), join data_left.csv with data_right_2.csv

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Joining Tables Exercises

.pull-left[
## data_left.csv
```{r}
head(gapminder, 3) |> 
  select(country, year, pop) |> 
  kable()
```
]

.pull-right[
## data_right_2.csv
```{r}
head(gapminder, 3) |> 
  select(location = country, date = year, gdpPercap) |>
  kable()
```
]

```r
data_left <- read_csv("data_left.csv")
data_right_2 <- read_csv("data_right_2.csv")

data_join_2 <- 
  full_join(data_left, data_right_2, by = join_by(country == location, year == date))
```

Note:

```r
data_join_2 <- full_join(data_left, data_right_2)
```

```{r results='asis'}
colorize("! `by` must be supplied when `x` and `y` have no common variables.", "red")
```

---

# Joining Tables Exercises

## Using a **_join()** function (e.g., `left_join()`, `right_join()`, `inner_join()`, or `full_join()`) join data_left.csv with data_right_3.csv

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Joining Tables Exercises

.pull-left[
## data_left.csv
```{r}
head(gapminder) |> 
  select(country, year, pop) |> 
  kable()
```
]

.pull-right[
## data_right_3.csv
```{r}
gapminder |> 
  select(country, continent) |> 
  distinct() |> 
  head() |> 
  kable()
```
]

```r
data_left <- read_csv("data_left.csv")
data_right_3 <- read_csv("data_right_3.csv")

data_join_3 <- full_join(data_left, data_right_3)
# or
data_join_3 <- full_join(data_left, data_right_3, by = join_by(country))
```

---

class: title-slide, middle,

## Map Visualisations

---

# Map Visualisations Exercises

## In ggplot R code...
- ## Design a world map showing countries' life expectancy

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Map Visualisations Exercises

```{r echo=TRUE, fig.height=4}
map_world <- map_data("world") 

map_gapminder <- full_join(gapminder, map_world, by = c("country" = "region"))

ggplot(map_gapminder) +
  aes(x = long, y = lat, group = group, fill = lifeExp) +
  geom_polygon()
```

`r faa("exclamation-triangle", animate="flash", speed="slow", color="red")` In R, only the latest data are shown, no Sum aggregation on multiple value.

---

# Map Visualisations Exercises

## In ggplot R code...
- ## Design a world map showing countries' life expectancy in 1952

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Map Visualisations Exercises

```{r echo=TRUE, fig.height=4}
map_world <- map_data("world") 

gap_1952 <- gapminder %>% 
  filter(year == 1952)

map_gap_1952 <- full_join(gap_1952, map_world, by = c("country" = "region"))

ggplot(map_gap_1952) +
  aes(x = long, y = lat, group = group, fill = lifeExp) +
  geom_polygon()
```

---

# Map Visualisations Exercises

## In ggplot R code...
- ## Design a world map showing countries' population in 1952

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Map Visualisations Exercises

```{r echo=TRUE, fig.height=4}
map_world <- map_data("world") 

gapminder %>% 
  filter(year == 1952) %>% 
  full_join(map_world, by = c("country" = "region")) %>% 
  ggplot(aes(x = long, y = lat, group = group, fill = pop)) +
  geom_polygon()
```

---

class: title-slide, middle,

## Time Series Visualisations

---

# Time Series Visualisations Exercises

## In ggplot R code...
- ## Design a time series visualisation showing the evolution of countries' life expectancy

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Time Series Visualisations Exercises

```{r echo=TRUE, fig.height=5}
ggplot(gapminder) +
  aes(year, lifeExp, group = country, color = continent) +
  geom_line()
```

---

# Time Series Visualisations Exercises

## In ggplot R code...
- ## Design a time series visualisation showing the evolution of countries' population and add a filter by country

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Time Series Visualisations Exercises

```{r echo=TRUE, fig.height=5}
library(plotly)

timeseries_plot <- ggplot(gapminder) +
  aes(year, lifeExp, group = country, color = continent) +
  geom_line()

ggplotly(timeseries_plot)
```

---

class: title-slide, middle,

## Part 4: Scatter Plots

---

# Scatter Plots Exercises

## In ggplot R code, design a Scatter Plot with countries' life expectancy and gdpPercap, and customise this scatter plot

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Scatterplots Exercises

```{r echo=TRUE, fig.width=12, fig.height=2}
ggplot(gapminder) +
  aes(gdpPercap, lifeExp, color = continent, size = pop) +
  geom_point(alpha = 0.2) +
  facet_wrap(~ year, nrow = 1) +
  scale_x_continuous(
    labels = scales::unit_format(unit = "K", scale = 1e-3),
    limits = c(0, 50000),
    breaks = c(20000, 40000)
  ) + 
  labs(
    x = "GDP per Capita in USD",
    y = "Life Expectancy",
    title = "Evolution of the relationship between life expectancy and GDP from 1952 to 2007 per continent."
  ) +
  theme_classic() +
  theme(text = element_text(family = "serif")) +
  guides(color = "none", size = "none")
```

---

class: title-slide, middle,

## Part 5: Bar Chart

---

# Bar Chart Exercises

## In ggplot R code, design a Bar Chart with the average life expectancy by continent and customise the colors

```{r}
countdown(minutes = 5, warn_when = 60)
```

---

# Bar Chart Exercises

```{r echo=TRUE, fig.width=12, fig.height=2}
gapminder %>%
  group_by(continent, year) %>%
  summarise(m_lifeexp = mean(lifeExp, na.rm = TRUE)) %>%
  ggplot(aes(reorder(continent, m_lifeexp), m_lifeexp, fill = continent)) +
  geom_col() +
  facet_wrap(~ year, nrow = 1) +
  scale_fill_manual(values = c("#9933FF", "#33FFFF", "red", "darkblue", "chartreuse3")) +
  labs(
    x = "",
    y = "Average Life Expectancy",
    fill = "Continent",
    title = "Evolution of the average life expectancy per continent from 1952 to 2007 per continent."
  ) +
  theme_classic() +
  theme(
    text = element_text(family = "serif"),
    axis.text.x = element_blank()
  )
```

---
class: inverse, mline, center, middle

# Report Design

---

# Report Strategy

Creating an prefect Quarto report is hard, so go step by step:

#### Step 1: Basic Figures

Create the required figures in a R script and make sure you have customised your figures as much as you can.

#### Step 2: Basic Report

Create a default Quarto report and Render if without changing anything.

#### Step 3: Figure Addition

Then add each figure separately and Render each time to check that there is no error and you are happy with the output document.

#### Step 4: Report Improvement

In the report bring the last modifications and render your final version. Once you are happy with this version, upload the folder on GitHub.

---

# Default Quarto and Render

Start from the default template and render as often as possible

.pull-left[
```{r out.width='100%'}
include_img("quarto_default.png")
```
]

.pull-right[
```{r out.width='100%'}
include_img("quarto_create.png")
```
]

---

# Change the YAML

.pull-left[
Modify the YAML to include:

- Your Title,
- Eventually a subtitle,
- The date,
- Your name,
- An html theme,
- Basic chunk options.
]

.pull-right[
```
---
title: "My First Quarto Document"
subtitle: "My Subtitle"
author: "Damien Dupre"
date: "99/99/9999"
format:
  html: 
    theme: sandstone
    backgroundcolor: lightgrey
execute:
  echo: false
  warning: false
  message: false
---
```
]

see [https://quarto.org/docs/output-formats/html-themes.html](https://quarto.org/docs/output-formats/html-themes.html) on how to change the theme

---

# Add your first Code chunk

```r
`r ''````{r}
#| label: setup
#| include: false

# libraries
library(tidyverse)
  
# data
data_left <- read_csv("data_left.csv")
data_right_1 <- read_csv("data_right_1.csv")

data_join_1 <- full_join(data_left, data_right_1)
``````

`r faa("exclamation-triangle", animate="flash", speed="slow", color="red")` Don't forget:

- Use the label and include options
- Load your libraries but don't install packages
- Read your data
- Make your transformations

---

# Add your Visualisations

- Use 1 chunk per Visualisation

- Render after each modification to check that nothing has been broken

- Use chuck options to define figure caption and figure size

```r
`r ''````{r}
#| fig-cap: "Map of Life Expectancy in 1952"
#| fig-width: 6
#| fig-height: 6

map_world <- map_data("world") 

gap_1952 <- gapminder %>% 
  filter(year == 1952)

map_gap_1952 <- full_join(gap_1952, map_world, by = c("country" = "region"))

ggplot(map_gap_1952) +
  aes(x = long, y = lat, group = group, fill = lifeExp) +
  geom_polygon()
``````

---

# Add your Text

- Position your text with second level headers before/after each visualisation.

- Show your skills in Markdown to include a lot of style on your text.

```{r}
include_graphics("https://i2.wp.com/www.opencpu.org/images/markdown-everywhere.jpg?w=578&ssl=1")
```

---
class: title-slide, middle

## Live Demo

---
class: inverse, mline, left, middle

<img class="circle" src="https://github.com/damien-dupre.png" width="250px"/>

# Thanks for your attention and don't hesitate to ask if you have any question!

[`r fa(name = "twitter")` @damien_dupre](http://twitter.com/damien_dupre)  
[`r fa(name = "github")` @damien-dupre](http://github.com/damien-dupre)  
[`r fa(name = "link")` damien-datasci-blog.netlify.app](https://damien-datasci-blog.netlify.app)  
[`r fa(name = "paper-plane")` damien.dupre@dcu.ie](mailto:damien.dupre@dcu.ie)